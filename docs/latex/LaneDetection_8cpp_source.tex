\hypertarget{LaneDetection_8cpp_source}{}\section{Lane\+Detection.\+cpp}
\label{LaneDetection_8cpp_source}\index{/home/soobin/\+Documents/\+Sandbox/\+I\+G\+V/src/\+Lane\+Detection.\+cpp@{/home/soobin/\+Documents/\+Sandbox/\+I\+G\+V/src/\+Lane\+Detection.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"LaneDetection.hpp"}
00002 
00003 \textcolor{keyword}{using} \textcolor{keyword}{namespace} igv;
00004 \textcolor{keyword}{using} \textcolor{keyword}{namespace} std;
00005 \textcolor{keyword}{using} \textcolor{keyword}{namespace} cv;
00006 
00007 \textcolor{comment}{// Stream operator overload, allows you to print Lanes}
00008 ostream& igv::operator<<(ostream& os, Lane& lane)\{
00009 
00010     os << \textcolor{stringliteral}{"Lane Slope: "} << lane.slope << endl;
00011     os << (lane.slope == 0.0f? \textcolor{stringliteral}{" Y-Intercept: "} : \textcolor{stringliteral}{" X-Intercept: "});
00012     os << lane.intercept << endl;
00013 
00014     \textcolor{keywordflow}{return} os;
00015 \}
00016 
00017 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{\_\_NVCC\_\_}   \textcolor{comment}{// if not using the GPU}
00018 
00019 \textcolor{comment}{/* Lane Detection Function:}
00020 \textcolor{comment}{ * }
00021 \textcolor{comment}{ * Reads an image and finds the largest Lanes and fills an array with the 4 largest}
00022 \textcolor{comment}{ * @param: LaneArray: a preexisting array full of lanes that gets modified by the function}
00023 \textcolor{comment}{ * @param: image: a preexisting matrix representing an image that gets read for lanes}
00024 \textcolor{comment}{ * @retval: returns the number of lanes detected total}
00025 \textcolor{comment}{ * }
00026 \textcolor{comment}{ */}
00027 
00028 uint32\_t LaneDetector::DetectLanes(array<Lane, 4>& LaneArray, Mat& image)\{
00029 
00030     \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DEBUG}
00031     Mat imgcopy;
00032     image.copyTo(imgcopy);
00033     \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00034 
00035     Mat gray, edged;
00036     cvtColor(image, gray, COLOR\_BGR2GRAY);
00037     Canny(gray, edged, 200, 200 );
00038 
00039     vector<Vec4i> linesP;  \textcolor{comment}{// a vector to fill with line points}
00040     HoughLinesP(edged, linesP, 1, CV\_PI/256, 80, 80, 10);  \textcolor{comment}{// find the lines}
00041 
00042     \textcolor{keywordflow}{if}(linesP.size() < 1) \textcolor{keywordflow}{return} 0; \textcolor{comment}{// if there is less than one line return 0 lanes}
00043 
00044     \textcolor{comment}{// store index and magnitiude of largest lines and a temporary magnitude}
00045     \textcolor{keyword}{struct} linedata\{
00046 
00047       \textcolor{keywordtype}{double} mag;
00048       uint32\_t index;
00049 
00050     \} largest[4] = \{\{0.0f,0\}, \{0.0f,0\}, \{0.0f, 0\}, \{0.0f, 0\}\};
00051 
00052     \textcolor{keywordtype}{double} mag;
00053 
00054     \textcolor{keywordflow}{for}( uint32\_t i = 0; i < linesP.size(); i++)\{  \textcolor{comment}{// find the two largest lines}
00055 
00056         mag = linesP[i][X1] - linesP[i][X0] + linesP[i][Y1] - linesP[i][Y0];
00057 
00058         \textcolor{keywordflow}{if}(mag > largest[0].mag)
00059             largest[0] = \{mag, i\}; \textcolor{comment}{// if larger than the largest then replace it}
00060         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(mag > largest[1].mag)
00061             largest[1] = \{mag, i\}; \textcolor{comment}{// same here except second largest}
00062         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(mag > largest[2].mag)
00063             largest[2] = \{mag, i\};
00064         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(mag > largest[3].mag)
00065             largest[3] = \{mag, i\};
00066     \}
00067 
00068     \textcolor{keywordtype}{double} slope; \textcolor{comment}{// temporary slope value}
00069     \textcolor{keywordtype}{int} intercept; \textcolor{comment}{// temporary intercept value}
00070 
00071     \textcolor{keywordflow}{for}(uint32\_t i = 0; i < 4 && i < linesP.size(); i++)\{  \textcolor{comment}{// put the two biggest lines in the Lane
       Vector }
00072 
00073         \textcolor{keywordflow}{if}(linesP[largest[i].index][X0] == linesP[largest[i].index][X1])\{ \textcolor{comment}{// horizontal }
00074 
00075             slope = DBL\_MAX;
00076             intercept = linesP[largest[i].index][X0];
00077         \}
00078         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(linesP[largest[i].index][Y0] == linesP[largest[i].index][Y1])\{ \textcolor{comment}{// vertical}
00079 
00080             slope = 0.0f;
00081             intercept = linesP[largest[i].index][Y0];
00082         \}
00083         \textcolor{keywordflow}{else}\{
00084         \textcolor{comment}{// m = deltay/deltax}
00085         slope = (linesP[largest[i].index][Y1] - linesP[largest[i].index][Y0])
00086                     / (linesP[largest[i].index][X1] - linesP[largest[i].index][X0]);
00087         \textcolor{comment}{// b = Yo - mXo}
00088         intercept = (linesP[largest[i].index][Y0] - slope*linesP[largest[i].index][X0]);
00089         \}
00090 
00091         LaneArray[i] = \{ slope, intercept \};
00092 
00093         \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DEBUG} \textcolor{comment}{// if debugging then print the image with lines}
00094 
00095         line(imgcopy, Point(linesP[largest[i].index][X0], linesP[largest[i].index][Y0]),
00096                     Point(linesP[largest[i].index][X1], linesP[largest[i].index][Y1]), Scalar(0, 0, 
      255));
00097 
00098         \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00099 
00100     \}
00101 
00102     \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DEBUG}
00103     imwrite(\textcolor{stringliteral}{"../test/StaticLDed.png"}, imgcopy);
00104     \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00105 
00106     \textcolor{keywordflow}{return} linesP.size();  \textcolor{comment}{// return how many lines are seen}
00107 \}
00108 
00109 \textcolor{comment}{// same things but not static}
00110 
00111 \textcolor{keywordtype}{void} LaneDetector::DetectLanes(Mat& image)\{
00112 
00113     busy = \textcolor{keyword}{true};
00114 
00115     \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DEBUG}
00116     Mat imgcopy;
00117     image.copyTo(imgcopy);
00118     \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00119 
00120     Mat gray, edged;
00121     cvtColor(image, gray, COLOR\_BGR2GRAY);
00122     Canny(gray, edged, 180, 180 );
00123 
00124     vector<Vec4i> linesP;  \textcolor{comment}{// a vector to fill with line points}
00125     HoughLinesP(edged, linesP, 2, CV\_PI/256, 20);  \textcolor{comment}{// find the lines}
00126 
00127     \textcolor{keywordflow}{if}(!linesP.size())\{
00128         \textcolor{keyword}{this}->numlanes = 0;
00129         \textcolor{keywordflow}{return}; \textcolor{comment}{// if there is less than one line return 0 lanes}
00130     \}
00131     \textcolor{comment}{// store index and magnitiude of largest lines and a temporary magnitude}
00132     \textcolor{keyword}{struct} linedata\{
00133 
00134       \textcolor{keywordtype}{double} mag;
00135       uint32\_t index;
00136 
00137     \} largest[4] = \{\{0.0f,0\}, \{0.0f,0\}, \{0.0f, 0\}, \{0.0f, 0\}\};
00138 
00139     \textcolor{keywordtype}{double} mag;
00140 
00141     \textcolor{keywordflow}{for}( uint32\_t i = 0; i < linesP.size(); i++)\{  \textcolor{comment}{// find the two largest lines}
00142 
00143         mag = linesP[i][X1] - linesP[i][X0] + linesP[i][Y1] - linesP[i][Y0];
00144 
00145         \textcolor{keywordflow}{if}(mag > largest[0].mag)
00146             largest[0] = \{mag, i\}; \textcolor{comment}{// if larger than the largest then replace it}
00147         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(mag > largest[1].mag)
00148             largest[1] = \{mag, i\}; \textcolor{comment}{// same here except second largest}
00149         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(mag > largest[2].mag)
00150             largest[2] = \{mag, i\};
00151         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(mag > largest[3].mag)
00152             largest[3] = \{mag, i\};
00153     \}
00154 
00155     \textcolor{keywordtype}{double} slope; \textcolor{comment}{// temporary slope value}
00156     \textcolor{keywordtype}{int} intercept; \textcolor{comment}{// temporary intercept value}
00157 
00158     \textcolor{keywordflow}{for}(uint32\_t i = 0; i < 4 && i < linesP.size(); i++)\{  \textcolor{comment}{// put the two biggest lines in the Lane
       Vector }
00159 
00160         \textcolor{keywordflow}{if}(linesP[largest[i].index][X0] == linesP[largest[i].index][X1])\{ \textcolor{comment}{// horizontal }
00161 
00162             slope = DBL\_MAX;
00163             intercept = linesP[largest[i].index][X0];
00164         \}
00165         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(linesP[largest[i].index][Y0] == linesP[largest[i].index][Y1])\{ \textcolor{comment}{// vertical}
00166 
00167             slope = 0.0f;
00168             intercept = linesP[largest[i].index][Y0];
00169         \}
00170         \textcolor{keywordflow}{else}\{
00171         \textcolor{comment}{// m = deltay/deltax}
00172         slope = (linesP[largest[i].index][Y1] - linesP[largest[i].index][Y0])
00173                     / (linesP[largest[i].index][X1] - linesP[largest[i].index][X0]);
00174         \textcolor{comment}{// b = Yo - mXo}
00175         intercept = (linesP[largest[i].index][Y0] - slope*linesP[largest[i].index][X0]);
00176         \}
00177 
00178         \textcolor{keyword}{this}->lanes[i] = (Lane)\{ slope, intercept \};
00179 
00180         \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DEBUG} \textcolor{comment}{// if debugging then print the image with lines}
00181 
00182         line(imgcopy, Point(linesP[largest[i].index][X0], linesP[largest[i].index][Y0]),
00183                     Point(linesP[largest[i].index][X1], linesP[largest[i].index][Y1]), Scalar(0, 0, 
      255));
00184 
00185         \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00186 
00187     \}
00188 
00189     \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DEBUG}
00190     imwrite(\textcolor{stringliteral}{"../test/LDed.png"}, imgcopy);
00191     \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00192 
00193     busy = \textcolor{keyword}{false};
00194     \textcolor{keyword}{this}->numlanes = linesP.size();  \textcolor{comment}{// return how many lines are seen}
00195 
00196 \}
00197 
00198 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else} \textcolor{comment}{// if we are using the GPU}
00199 
00200 \textcolor{comment}{// Same Algorithm but using GPU}
00201 
00202 uint32\_t LaneDetector::DetectLanes(array<Lane, 2>& lanes, Mat& image)\{
00203 
00204     busy = \textcolor{keyword}{true};
00205 
00206     GpuMat img, edge, lines;
00207     vector<uint32\_t> votes;
00208     vector<Vec2f> linesP;
00209 
00210     uint32\_t best[2] = \{0\};
00211     uint32\_t index[2];
00212 
00213     img.upload(image);
00214 
00215     gpu::cvtColor(img, img, COLOR\_BGR2GRAY);
00216     gpu::Canny(img, edge, 50, 200);
00217 
00218     gpu::HoughLines(edge, lines, 1,  CV\_PI/128, 10);
00219     gpu::HoughLinesDownload(lines, linesP, votes);
00220 
00221     \textcolor{keywordflow}{if}(!linesP.size()) \textcolor{keywordflow}{return} 0;
00222 
00223     \textcolor{keywordflow}{for}(uint32\_t i = 0; i < linesP.size(), i++)\{
00224 
00225         \textcolor{keywordflow}{if}(votes[i] > best[0])\{
00226             best[0] = votes[i];
00227             index[0] = i;
00228         \}
00229         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(votes[i] > best[1])\{
00230             best[1] = votes[i];
00231             index[1] = i;
00232         \}
00233     \}
00234 
00235     \textcolor{keywordtype}{double} slope;
00236     \textcolor{keywordtype}{int} intercept;
00237 
00238     \textcolor{keywordflow}{for}(uint32\_t i = 0; i < 2; i++)\{
00239 
00240         slope = tan(CV\_PI/2 - linesP[index[i]][1]); \textcolor{comment}{// y/x = tan(theta)}
00241         \textcolor{keywordflow}{if}(linesP[index[i]][1] == || linesP[index[i][1]] == CV\_PI/2)
00242             intercept = linesP[index[i][0]];  \textcolor{comment}{// if slope is 0 or inf, intercept is rho}
00243         \textcolor{keywordflow}{else} intercept = -1*slope*linesP[index[i]][0]/cos(linesP[index[i]][1]);
00244 
00245         lanes[i] = \{ slope, intercept \};
00246 
00247         \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef}
00248 
00249 
00250 
00251 
00252 
00253         \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00254 
00255     \}
00256 
\Hypertarget{LaneDetection_8cpp_source_l00257}\hyperlink{LaneDetection_8cpp_a9a499e6ee417732a06f9d3a3f6433546}{00257}     \textcolor{keyword}{this}->numlanes = linesP.size();
\Hypertarget{LaneDetection_8cpp_source_l00258}\hyperlink{LaneDetection_8cpp_ab5707289495a33e90ac7ce232adcca4c}{00258}     busy = \textcolor{keyword}{false};
00259 
00260 \}
00261 
00262 
00263 \textcolor{keywordtype}{void} LaneDetector::DetectLanes(Mat& image)\{
00264 
00265     busy = \textcolor{keyword}{true};
00266 
00267     GpuMat img, edge, lines;
00268     vector<uint32\_t> votes;
00269     vector<Vec2f> linesP;
00270 
00271     uint32\_t best[2] = \{0\};
00272     uint32\_t index[2];
00273 
00274     img.upload(image);
00275 
00276     gpu::cvtColor(img, img, COLOR\_BGR2GRAY);
00277     gpu::Canny(img, edge, 50, 200);
00278 
00279     gpu::HoughLines(edge, lines, 1,  CV\_PI/128, 10);
00280     gpu::HoughLinesDownload(lines, linesP, votes);
00281 
00282     \textcolor{keywordflow}{if}(!linesP.size())\{
00283         \textcolor{keyword}{this}->numlanes = 0;
00284         \textcolor{keywordflow}{return};
00285     \}
00286 
00287     \textcolor{keywordflow}{for}(uint32\_t i = 0; i < linesP.size(), i++)\{
00288 
00289         \textcolor{keywordflow}{if}(votes[i] > best[0])\{
00290             best[0] = votes[i];
00291             index[0] = i;
00292         \}
00293         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(votes[i] > best[1])\{
00294             best[1] = votes[i];
00295             index[1] = i;
00296         \}
00297     \}
00298 
00299     \textcolor{keywordtype}{double} slope;
00300     \textcolor{keywordtype}{int} intercept;
00301 
00302     \textcolor{keywordflow}{for}(uint32\_t i = 0; i < 2; i++)\{
00303 
00304         slope = tan(CV\_PI/2 - linesP[index[i]][1]); \textcolor{comment}{// y/x = tan(theta)}
00305         \textcolor{keywordflow}{if}(linesP[index[i]][1] == || linesP[index[i][1]] == CV\_PI/2)
00306             intercept = linesP[index[i][0]];  \textcolor{comment}{// if slope is 0 or inf, intercept is rho}
00307         \textcolor{keywordflow}{else} intercept = -1*slope*linesP[index[i]][0]/cos(linesP[index[i]][1]);
00308 
00309         lanes[i] = \{ slope, intercept \};
00310 
00311         \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DEBUG}
00312 
00313 
00314 
00315 
00316 
00317         \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00318 
00319     \}
00320 
00321     \textcolor{keyword}{this}->numlanes = linesP.size();
00322     busy = \textcolor{keyword}{false};
00323 
00324 \}
00325 
00326 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
\end{DoxyCode}
