\hypertarget{BasicNavigation_8cpp_source}{}\section{Basic\+Navigation.\+cpp}
\label{BasicNavigation_8cpp_source}\index{/home/soobin/\+Documents/\+Sandbox/\+I\+G\+V/src/\+Basic\+Navigation.\+cpp@{/home/soobin/\+Documents/\+Sandbox/\+I\+G\+V/src/\+Basic\+Navigation.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"BasicNavigation.hpp"}
00002 
00003 \textcolor{keyword}{using} \textcolor{keyword}{namespace} igv;
00004 \textcolor{keyword}{using} \textcolor{keyword}{namespace} std;
00005 \textcolor{keyword}{using} \textcolor{keyword}{namespace} chrono;
00006 
00007 \textcolor{comment}{/*!}
00008 \textcolor{comment}{  * @brief Set the Speed of both motors}
00009 \textcolor{comment}{  * @param speed The Speed to set it to [-127, 127]}
00010 \textcolor{comment}{  */}
00011 \textcolor{keywordtype}{void} MotorController::SetSpeed(Speed speed)\{
00012 
00013   SetSpeed(LEFT, speed);
00014   SetSpeed(RIGHT, speed);
00015 
00016 \}
00017 
00018 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{SIMULATION}
00019 
00020 \textcolor{comment}{/*!}
00021 \textcolor{comment}{  * @brief Creates A Motor Controller Object}
00022 \textcolor{comment}{*/}
00023 MotorController::MotorController() : myport(MCPORT, B9600)\{
00024   busy = \textcolor{keyword}{false};
00025   speed = 0;
00026   direction = 0;
00027 \}
00028 
00029 \textcolor{comment}{/*!}
00030 \textcolor{comment}{  * @brief Sets the Speed of a motor}
00031 \textcolor{comment}{  * }
00032 \textcolor{comment}{  * @param motor The Motor to Set the Speed of}
00033 \textcolor{comment}{  * @param speed The Speed to Set it to}
00034 \textcolor{comment}{*/}
00035 \textcolor{keywordtype}{void} MotorController::SetSpeed(Motor motor, Speed speed) \{
00036 
00037   uint8\_t command = 0;
00038   string msg = \textcolor{stringliteral}{" "};
00039   uint8\_t magnitude = abs(speed) >> 1;
00040 
00041   \textcolor{keywordflow}{if} (motor == LEFT)
00042     command = speed < 0 ? 63 - magnitude : 64 + magnitude;
00043 
00044   \textcolor{keywordflow}{else}
00045     command = speed < 0 ? 191 - magnitude : 192 + magnitude;
00046 
00047   command = (!command)? 1: (command == 0xff)? 254: command;
00048 
00049   msg[0] = command;
00050 
00051   \textcolor{keyword}{this}->myport.Write(msg);
00052 
00053 \}
00054 
00055 \textcolor{comment}{/*!}
00056 \textcolor{comment}{  *  @brief Completes a turn while moving }
00057 \textcolor{comment}{  * }
00058 \textcolor{comment}{  *  @param deltadir Change in direction, [0, 2pi] -> [0, 256]}
00059 \textcolor{comment}{  *  @param speeddiff How much to take off of the motor speed [0, 127]}
00060 \textcolor{comment}{  * }
00061 \textcolor{comment}{  *  !The slower the speed and faster the speeddiff the faster and less wide the}
00062 \textcolor{comment}{  *  !turn}
00063 \textcolor{comment}{  */}
00064 
00065 \textcolor{keywordtype}{void} MotorController::ChangeDirection(DeltaDir deltadir, Speed speeddiff) \{
00066 
00067   \textcolor{keywordflow}{if} (busy || !deltadir || !speeddiff) \textcolor{keywordflow}{return}; \textcolor{comment}{// if busy or with bad params exit}
00068 
00069   \textcolor{keywordtype}{double} ohmega; \textcolor{comment}{// angular velocity in terms of change in direction per second}
00070                  \textcolor{comment}{// using dir: 0 = 0, 256 = 2pi}
00071   milliseconds waittime; \textcolor{comment}{// wait time to travel dir angular distance}
00072 
00073   direction += deltadir; \textcolor{comment}{// update the direction }
00074 
00075   speed &= 0x7f; \textcolor{comment}{// make sure the value is seven bits}
00076 
00077   \textcolor{keywordflow}{if} (((\textcolor{keywordtype}{int})speeddiff + \textcolor{keyword}{this}->speed) > 127)
00078     speeddiff = 127 - \textcolor{keyword}{this}->speed; \textcolor{comment}{// correct the speed diff if too high or low}
00079 
00080   \textcolor{keywordflow}{if} (((\textcolor{keywordtype}{int})\textcolor{keyword}{this}->speed - speeddiff) < -127)
00081     speeddiff = \textcolor{keyword}{this}->speed - 127;
00082 
00083   ohmega = ((\textcolor{keywordtype}{int})speeddiff << 7) / (PI * WHEELBASE); \textcolor{comment}{// get tangential speed and convert it to angular}
00084 
00085   waittime = milliseconds((uint64\_t)(1000 * abs(deltadir) / ohmega)); \textcolor{comment}{// calculate wait time in millis}
00086 
00087   busy = \textcolor{keyword}{true};
00088 
00089   SetSpeed(LEFT, deltadir > 0 ? \textcolor{keyword}{this}->speed - speeddiff
00090                               : \textcolor{keyword}{this}->speed + speeddiff); \textcolor{comment}{// give the motors their new speeds}
00091 
00092   SetSpeed(RIGHT, deltadir > 0 ? \textcolor{keyword}{this}->speed + speeddiff
00093                                : \textcolor{keyword}{this}->speed - speeddiff);
00094 
00095   this\_thread::sleep\_for(waittime); \textcolor{comment}{// wait until the turn has covered the delta}
00096 
00097   SetSpeed(\textcolor{keyword}{this}->speed); \textcolor{comment}{// go back to going straight}
00098 
00099   busy = \textcolor{keyword}{false};
00100 
00101 \}
00102 
00103 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
\end{DoxyCode}
